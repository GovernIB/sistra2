<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="../layout/mainLayout.xhtml">

	<f:metadata>
		<f:viewAction name="AREA" value="#{viewTramites.idArea}" />
		<f:viewAction action="#{viewTramites.init}" />
	</f:metadata>

	<ui:define name="content">

		<h:form id="form" style="height: 80%">

			<!-- Growl mensajes -->
			<p:growl id="growl" widgetVar="growl" showDetail="false" life="2000" sticky="false" />

			<!-- Toolbar -->
			<p:toolbar id="toolbar" styleClass="margin-bottom-3">

				<f:facet name="left">
		        	<h:panelGrid id="panelFiltro" columns="2" cellspacing="5">
			        	<p:inputText placeholder="#{msg['botones.buscar']}" value="#{viewTramites.filtro}" />
	           			<p:commandButton icon="fa fa-search" actionListener="#{viewTramites.filtrar}" process="panelFiltro" update=":form growl" />
	           		</h:panelGrid>
		        </f:facet>

		        <f:facet name="right">
		        	<h:panelGrid id="panelBotones" columns="7" cellspacing="5">
		        		<p:commandButton id="btnHelp" value="#{msg['botones.ayuda']}" icon="fa fa-question-circle-o" actionListener="#{viewTramites.ayudar()}" process="@this" update="growl" iconPos="top" />
		        	</h:panelGrid>
		        </f:facet>

		    </p:toolbar>

			<div class="ui-g"  style="height: 100%">

			<div class="ui-g-4 ui-g-nopad"  style="height: 99%">
				<!-- Toolbar -->
				<p:toolbar id="toolbar2">
					<f:facet name="left">
							<h:outputText value="#{msg['viewTramites.listadoAreas']}" />
		           	</f:facet>
		           	<f:facet name="right">
		           			<p:commandButton value="#{msg['botones.nuevo']}" icon="fa fa-file" actionListener="#{viewTramites.nuevaArea}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaArea}">
			        				<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoArea}" update="growl arbolArea"/>
			        		</p:commandButton>

			        		<p:commandButton id="btnConsultarArea" value="#{msg['botones.consultar']}" icon="fa fa-eye" actionListener="#{viewTramites.consultarArea}" process="@this" update="growl" rendered="#{not viewTramites.permiteEditarArea}" />
			        		<p:commandButton id="btnEditarArea" value="#{msg['botones.editar']}" icon="fa fa-edit ui-btn-icon-bottom" actionListener="#{viewTramites.editarArea}" process="@this" update="growl" rendered="#{viewTramites.permiteEditarArea}">
			        				<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoArea}" update="growl arbolArea"/>
			        		</p:commandButton>
					        <p:commandButton id="btnNuevoTramite"  value="#{msg['botones.nuevoTramite']}" icon="fa fa-file" actionListener="#{viewTramites.nuevoTramite}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaTramite}">
				     		     <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoTramite}" update="growl :form:dataTableTramites"/>
			   		        </p:commandButton>
			        		<p:menuButton value="Más..">
	        					<p:menuitem id="btnEliminarArea" value="#{msg['botones.eliminar']}" icon="fa fa-trash-o" actionListener="#{viewTramites.eliminarArea}" process="@this" update="growl arbolArea" rendered="#{viewTramites.permiteAltaArea}">
	        						<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['confirm.borrado']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
	        					</p:menuitem>
					        	<p:menuitem id="btnDominioArea" value="#{msg['botones.dominios']}" icon="fa fa-database" actionListener="#{viewTramites.dominioArea}" process="@this" update="growl"/>
					        	<p:menuitem id="btnDatosArea" value="#{msg['botones.datosFuente']}" icon="fa fa-table" actionListener="#{viewTramites.datosArea}" process="@this" update="growl"/>
	    					</p:menuButton>
					</f:facet>
				</p:toolbar>

				<p:tree id="arbolArea" value="#{viewTramites.areas}" var="area" style="width: 100%;height: 100%;overflow: auto;display: block"
						selection="#{viewTramites.areaSeleccionada}"
						selectionMode="single">
				        <p:treeNode>
				            <h:outputText value="#{area.identificador}" />
				        </p:treeNode>


						<p:ajax event="select"
		                        listener="#{viewTramites.onRowSelectArea}"
		                        update=":form:arbolArea :form:dataTableTramites :form:toolbarTramites"
		                        />

						<p:ajax event="unselect"
		                        listener="#{viewTramites.onRowUnselectArea}"
		                        update=":form:arbolArea :form:dataTableTramites :form:toolbarTramites"
		                        />

				</p:tree>

		    </div>
			<div class="ui-g-8 ui-g-nopad" style="padding-left:10px">

				<!-- Toolbar -->
				<p:toolbar id="toolbarTramites">
					<f:facet name="left">
							<h:outputText value="#{msg['viewTramites.listadoTramites']}"  />
							<h:outputText value=" - #{viewTramites.areaSeleccionada.data.identificador}" rendered="#{not empty viewTramites.areaSeleccionada}"  />
					</f:facet>
			        <f:facet name="right">
			        		<p:commandButton id="btnConsultarTramite" value="#{msg['botones.consultar']}" icon="fa fa-eye" actionListener="#{viewTramites.consultarTramite}" process="@this" update="growl" rendered="#{not viewTramites.permiteEditarTramite and not viewTramites.permiteAltaTramite}" />
			        		<p:commandButton id="btnEditarTramite" value="#{msg['botones.editarTramite']}" icon="fa fa-edit" actionListener="#{viewTramites.editarTramite}" process="@this" update="growl" rendered="#{viewTramites.permiteEditarTramite or viewTramites.permiteAltaTramite}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoTramite}" update="growl :form:dataTableTramites"/>
			        		</p:commandButton>
			        		<p:commandButton value="#{msg['botones.nuevaVersion']}" icon="fa fa-file" actionListener="#{viewTramites.nuevaVersion}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaTramite and viewTramites.tramiteSeleccionada ne null}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoNuevaVersion}" update="growl @form:dataTableTramites" />
			        		</p:commandButton>
			        		<p:commandButton id="btnVersionesTramite" value="#{msg['viewTramites.botones.versiones']}" icon="fa fa-level-down" actionListener="#{viewTramites.versionesTramite}" process="@this" update="growl"/>
			        		<p:menuButton value="Más..">
	        					<p:menuitem id="btnImportar"  value="#{msg['botones.importar']}" icon="fa fa-upload"  onclick="triggerImportarTramite(); return false;" rendered="#{viewTramites.permiteAltaArea}"></p:menuitem>
	        					<p:menuitem id="btnMoverTramite" value="#{msg['botones.mover']}" icon="fa fa-exchange" onclick="triggerMoverTramite();return false;" rendered="#{viewTramites.permiteAltaArea}"></p:menuitem>
			        			<p:menuitem id="btnEliminarTramite" value="#{msg['botones.eliminar']}" icon="fa fa-trash-o" actionListener="#{viewTramites.eliminarTramite}" process="@this" update="growl :form:dataTableTramites" rendered="#{viewTramites.permiteAltaTramite}">
			        				<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['confirm.borrado']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
			        			</p:menuitem>
			        			<p:menuitem id="btnProcedimientosTramite" value="#{msg['viewTramites.botones.procedimientos']}" icon="fa fa-eye" actionListener="#{viewTramites.procedimientosTramite}" process="@this" update="growl"/>
			        		</p:menuButton>
					</f:facet>
				</p:toolbar>

				<p:dataTable  id="dataTableTramites" var="td" value="#{viewTramites.listaTramiteVersiones}"
												 rows="10" emptyMessage="#{msg['error.emptyRows']}" rowExpandMode="single"
												 scrollable="true" scrollHeight="100%"
						                         paginator="true" paginatorPosition="bottom"
						                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
						                         rowsPerPageTemplate="5,10,15,30"
									        	 selectionMode="single" selection="#{viewTramites.tramiteSeleccionada}" rowKey="#{td.tramite.codigo}">

						<!-- Necesario para actualizar en controlador la fila seleccionada -->
						<p:ajax event="rowSelect" delay="500" listener="#{viewTramites.unSelectVersionTramite}" update="@form:toolbarTramites"/>
<!--              			<p:ajax event="rowDblselect" -->
<!-- 		                  		oncomplete="triggerDoubleClick();" -->
<!-- 		                        update=":form:dataTableTramites" -->
<!-- 		                        /> -->

				       <p:column style="width:16px">
				            <p:rowToggler />
				        </p:column>

						<!-- Columnas -->
					    <p:column headerText="#{msg['viewTramites.headerCodigo']}">
					        <h:outputText value="#{td.tramite.identificador}" />
					    </p:column>

					    <p:column headerText="#{msg['viewTramites.headerDescripcion']}">
					        <h:outputText value="#{td.tramite.descripcion}" />
					    </p:column>

		 				<p:column headerText="#{msg['viewTramites.headerActivo']}">
					        <p:selectBooleanCheckbox value="#{td.tramite.activo}" disabled="true" />
					    </p:column>

						<p:rowExpansion>
							<!-- Data table -->
							<p:dataTable  id="dataTable" var="tdVersiones" value="#{td.listaVersiones}"
										  rows="10" emptyMessage="#{msg['error.emptyRows']}"
										  styleClass="w95"
							        	  selectionMode="single" selection="#{viewTramites.versionSeleccionada}" rowKey="#{tdVersiones.codigo}">

								<!-- Necesario para actualizar en controlador la fila seleccionada -->
								<p:ajax event="rowSelect" delay="500" listener="#{viewTramites.unSelectTramite}" update="@form:toolbarTramites"/>

								<!-- Columnas -->
							    <p:column headerText="#{msg['viewTramitesVersion.headerVersion']}">
							        <h:outputText value="#{tdVersiones.numeroVersion}" />
							    </p:column>

							    <p:column headerText="#{msg['viewTramitesVersion.headerFlujo']}">
							     	<h:outputText value="#{msg['typeFlujo.'.concat(tdVersiones.tipoFlujo)]}" />
							    </p:column>

				 				<p:column headerText="#{msg['viewTramitesVersion.headerActiva']}">
							        <p:selectBooleanCheckbox value="#{tdVersiones.activa}" disabled="true" />
							    </p:column>

								<p:column headerText="#{msg['viewTramitesVersion.headerRelease']}">
							        <h:outputText value="#{tdVersiones.release}" />
							    </p:column>

								<p:column headerText="#{msg['viewTramitesVersion.headerBloqueado']}">
							        <h:outputText value="#{tdVersiones.datosUsuarioBloqueo}" />
							    </p:column>

							</p:dataTable>
						</p:rowExpansion>

					</p:dataTable>
				</div>
			</div>

			<p:commandButton id="hiddenCommandImportar" styleClass="button"  action="#{viewTramites.importar()}"  style="display:none">
      			   <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoImportar}" update="growl form:dataTableTramites"  />
	        </p:commandButton>

	        <p:commandButton id="hiddenCommandMover" styleClass="button"  action="#{viewTramites.moverTramite()}"  style="display:none">
      			   <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoMoverTramite}" update="growl form:dataTableTramites"  />
	        </p:commandButton>

			<h:outputScript >
		 		function triggerImportarTramite() {
		        	document.getElementById("form:hiddenCommandImportar").click();
		     	}

	      	  	function triggerMoverTramite() {
	        		document.getElementById("form:hiddenCommandMover").click();
	      	  	}

	      	  	function triggerVersionesTramite() {
	        		document.getElementById("form:btnVersionesTramite").click();
	      	  	}

	      	  	function triggerDoubleClick() {
	      	  		document.getElementById("form:btnEditarTramite").click();
	      	  	}

		    </h:outputScript>

		    <p:confirmDialog global="true" >
				<p:outputPanel styleClass="confirmar_botonera">
		        	<p:commandButton value="#{msg['botones.si']}" type="button" styleClass="ui-confirmdialog-yes boton-azul" icon="fa fa-check"  process="@form"/>
		        	<p:commandButton value="#{msg['botones.no']}" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-close" process="@this"/>
				</p:outputPanel>
		    </p:confirmDialog>
		</h:form>

	</ui:define>

</ui:composition>
