<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="../layout/mainLayout.xhtml">

	<f:metadata>
		<f:viewAction name="AREA" value="#{viewTramites.idArea}" />
		<f:viewAction action="#{viewTramites.init}" />
	</f:metadata>

	<ui:define name="content">

		<h:form id="form" style="height: 80%">

			<!-- Growl mensajes -->
			<p:growl id="growl" widgetVar="growl" showDetail="false" life="2000" sticky="false" />

			<div class="ui-g"  style="height: 100%">

			<div class="ui-g-3 ui-g-nopad"  style="height: 99%">
				<!-- Toolbar -->
				<p:toolbar id="toolbarArea">
					<f:facet name="left">
						<h:outputText value="#{msg['viewTramites.listadoAreas']}" />
		           	</f:facet>
		           	<f:facet name="right">
		           			<p:commandButton value="#{msg['botones.nuevo']}" icon="fa fa-file" actionListener="#{viewTramites.nuevaArea}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaArea}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoArea}" update="growl @form"/>
			        		</p:commandButton>
			        		<p:commandButton id="btnConsultarArea" value="#{msg['botones.consultar']}" icon="fa fa-eye" actionListener="#{viewTramites.consultarArea}" process="@this" update="growl" rendered="#{not viewTramites.permiteEditarArea and viewTramites.seleccionadaArea}" />
			        		<p:commandButton id="btnEditarArea" value="#{msg['botones.editar']}" icon="fa fa-edit ui-btn-icon-bottom" actionListener="#{viewTramites.editarArea}" process="@this" update="growl" rendered="#{viewTramites.permiteEditarArea and viewTramites.seleccionadaArea}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoArea}" update="growl areas"/>
			        		</p:commandButton>

			        		<p:commandButton id="btnEliminarArea" value="#{msg['botones.eliminar']}" icon="fa fa-trash-o" actionListener="#{viewTramites.eliminarArea}" process="@this" update="@form growl" rendered="#{viewTramites.permiteAltaArea and viewTramites.seleccionadaArea}">
	        					<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['confirm.borrado']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
	        				</p:commandButton>

					</f:facet>
				</p:toolbar>

			    <p:dataTable id="areas" var="area" value="#{viewTramites.listaAreas}" emptyMessage="#{msg['error.emptyRows']}"
			    	 scrollable="true" scrollHeight="100%"
			   		selection="#{viewTramites.listaAreasSeleccionadas}" rowKey="#{area.codigo}">
					<p:ajax event="rowSelectCheckbox" listener="#{viewTramites.filtrar}" update="@form:dataTableTramites @form:toolbarArea @form:toolbarTramites"/>
					<p:ajax event="rowSelect" global="false" listener="#{viewTramites.filtrar}" update="@form:dataTableTramites @form:toolbarArea @form:toolbarTramites"/>
					<p:ajax event="rowUnselect" listener="#{viewTramites.filtrar}" update="@form:dataTableTramites @form:toolbarArea @form:toolbarTramites"/>
					<p:ajax event="rowUnselectCheckbox" listener="#{viewTramites.filtrar}" update="@form:dataTableTramites @form:toolbarArea @form:toolbarTramites"/>
					<p:ajax event="toggleSelect" listener="#{viewTramites.filtrar}" update="@form:dataTableTramites @form:toolbarArea @form:toolbarTramites" />
					<p:ajax event="rowDblselect" oncomplete="triggerDoubleClickArea();" update="@form:dataTableTramites @form:toolbarArea @form:toolbarTramites" />

			        <p:column selectionMode="multiple" style="width:16px;text-align:center"/>
			        <p:column>
			            <h:outputText value="#{area.identificador}" />
			        </p:column>
			    </p:dataTable>

		    </div>
			<div class="ui-g-9 ui-g-nopad" style="padding-left:10px">

				<!-- Toolbar -->
				<p:toolbar id="toolbarTramites">
					<f:facet name="left">
				        		<p:remoteCommand name="search" actionListener="#{viewTramites.filtrar}" update="growl @form" />
				        		<p:inputText placeholder="#{msg['botones.buscar']}" value="#{viewTramites.filtro}" styleClass="margin-right-10" onkeypress="if (event.keyCode == 13) { search(); return false; }"/>
		           				<p:commandButton icon="fa fa-search" actionListener="#{viewTramites.filtrar}" process="@form" update="growl @form" styleClass="va-top"/>
					</f:facet>
			        <f:facet name="right">
			        	 <h:panelGroup rendered="#{viewTramites.seleccionadasAreas}">
			        	 	<p:commandButton id="btnNuevoTramite" value="#{msg['botones.nuevoTramite']}" icon="fa fa-file" actionListener="#{viewTramites.nuevoTramite}" process="@this" update="growl"  rendered="#{viewTramites.permiteAltaTramite and viewTramites.seleccionadaArea and viewTramites.versionSeleccionada eq null}">
				     		     <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoTramite}" update="growl @form"/>
			   		        </p:commandButton>

			        		<p:commandButton id="btnConsultarTramite" value="#{msg['botones.consultarTramite']}" icon="fa fa-eye" actionListener="#{viewTramites.consultarTramite}" process="@this" update="growl" rendered="#{not viewTramites.permiteEditarTramite and not viewTramites.permiteAltaTramite}" />
			        		<p:commandButton id="btnEditarTramite" value="#{msg['botones.editarTramite']}" icon="fa fa-edit" actionListener="#{viewTramites.editarTramite}" process="@this" update="growl" rendered="#{(viewTramites.permiteEditarTramite or viewTramites.permiteAltaTramite) and viewTramites.tramiteSeleccionada ne null}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoTramite}" update="growl @form"/>
			        		</p:commandButton>
			        		<p:commandButton value="#{msg['botones.nuevaVersion']}" icon="fa fa-file" actionListener="#{viewTramites.nuevaVersion}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaTramite and (viewTramites.tramiteSeleccionada ne null or viewTramites.versionSeleccionada ne null)}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoNuevaVersion}" update="growl @form" />
			        		</p:commandButton>

			        		<p:commandButton id="btnConsultarVersion" value="#{msg['botones.consultarVersion']}" icon="fa fa-edit" actionListener="#{viewTramites.consultarVersion}" process="@this" update="growl" rendered="#{not viewTramites.permiteEditarTramite and viewTramites.versionSeleccionada ne null}" />
							<p:commandButton id="btnEditarVersion" value="#{msg['botones.editarVersion']}" icon="fa fa-edit" actionListener="#{viewTramites.editarVersion}" process="@this" update="growl" rendered="#{viewTramites.permiteEditarTramite and viewTramites.versionSeleccionada ne null}" />

			        		<p:commandButton id="btnBloquear" value="#{msg['botones.bloquear']}" icon="fa fa-lock" actionListener="#{viewTramites.bloquear}" process="@this" update="growl @form"  rendered="#{(viewTramites.permiteEditarTramite or viewTramites.permiteAltaTramite) and viewTramites.versionSeleccionada ne null and viewTramites.permiteBloquear}">
			        			<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['viewTramitesVersion.bloquear.aviso']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
			        		</p:commandButton>
			        		<p:commandButton id="btnDesploquear" value="#{msg['botones.desbloquear']}" icon="fa fa-unlock" actionListener="#{viewTramites.desbloquear}" process="@this" update="growl" rendered="#{(viewTramites.permiteEditarTramite or viewTramites.permiteAltaTramite) and viewTramites.versionSeleccionada ne null and viewTramites.permiteDesbloquear}">
			        			<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoDesbloquear}" update="growl @form" />
			        		</p:commandButton>

			        		<p:menuButton value="#{msg['viewTramites.mas']}" rendered="#{not(not viewTramites.seleccionadasAreas or (not viewTramites.seleccionadaArea and viewTramites.seleccionadasAreas and viewTramites.tramiteSeleccionada eq null and viewTramites.versionSeleccionada eq null))}">
	        					<p:menuitem id="btnImportar"  value="#{msg['botones.importarTramite']}" icon="fa fa-upload"  onclick="triggerImportarTramite(); return false;" rendered="#{viewTramites.permiteEditarTramite or viewTramites.permiteAltaArea and viewTramites.seleccionadaArea}"></p:menuitem>
								<p:menuitem id="btnPrevisualizar"  value="#{msg['botones.previsualizarTramite']}" icon="fa fa-eye" actionListener="#{viewTramites.previsualizar}"  process="@this" update="growl @form"   rendered="#{viewTramites.permiteAltaTramite and viewTramites.versionSeleccionada ne null}" />

	        					<p:separator rendered="#{(viewTramites.tramiteSeleccionada ne null or viewTramites.versionSeleccionada ne null) and (viewTramites.permiteAltaArea and viewTramites.seleccionadaArea)}"/>

	        					<p:menuitem id="btnMoverTramite" value="#{msg['botones.moverTramite']}" icon="fa fa-exchange" onclick="triggerMoverTramite();return false;" rendered="#{viewTramites.permiteAltaArea and viewTramites.tramiteSeleccionada ne null}"></p:menuitem>
			        			<p:menuitem id="btnControlAcceso" value="#{msg['botones.controlAcceso']}" icon="fa fa-edit" onclick="triggerControlAcceso();return false;" rendered="#{viewTramites.permiteEditarTramite and viewTramites.versionSeleccionada ne null}"></p:menuitem>
			        			<p:menuitem id="btnEliminarTramite" value="#{msg['botones.eliminarTramite']}" icon="fa fa-trash-o" actionListener="#{viewTramites.eliminarTramite}" process="@this" update="growl @form" rendered="#{viewTramites.permiteAltaTramite and viewTramites.tramiteSeleccionada ne null}">
			        				<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['confirm.borrado']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
			        			</p:menuitem>

			        			<p:menuitem id="btnEliminarVersion" value="#{msg['botones.eliminarVersion']}" icon="fa fa-trash-o" actionListener="#{viewTramites.eliminarVersion}" process="@this" update="growl @form" rendered="#{viewTramites.permiteAltaTramite and viewTramites.versionSeleccionada ne null}">
			        				<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['confirm.borrado']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
			        			</p:menuitem>
        						<p:menuitem id="btnExportar" value="#{msg['botones.exportarVersion']}" icon="fa fa-download" actionListener="#{viewTramites.exportarVersion}" process="@this" update="growl @form"  rendered="#{viewTramites.permiteAltaTramite and viewTramites.versionSeleccionada ne null}" />
	        					<p:menuitem id="btnRefrescar" value="#{msg['botones.refrescarCache']}" icon="fa fa-refresh" actionListener="#{viewTramites.refrescar}" process="@this" update="growl @form" rendered="#{viewTramites.versionSeleccionada ne null}" />
					        	<p:menuitem id="btnDuplicar" value="#{msg['botones.duplicarVersion']}" icon="fa fa-copy" onclick="triggerClonarTramite(); return false;" rendered="#{viewTramites.permiteAltaTramite and viewTramites.versionSeleccionada ne null}" />
	        					<p:menuitem id="btnHistorial" value="#{msg['botones.historial']}" icon="fa fa-history" actionListener="#{viewTramites.historialVersion}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaTramite and viewTramites.versionSeleccionada ne null}" />

			        			<p:menuitem id="btnProcedimientosTramite" value="#{msg['viewTramites.botones.procedimientos']}" icon="fa fa-eye" actionListener="#{viewTramites.procedimientosTramite}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaArea and viewTramites.tramiteSeleccionada ne null}"/>

			        			<p:separator rendered="#{viewTramites.permiteAltaArea and viewTramites.seleccionadaArea}"/>
			        			<p:menuitem id="btnDominioArea" value="#{msg['botones.dominios']}" icon="fa fa-database" actionListener="#{viewTramites.dominioArea}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaArea and viewTramites.seleccionadaArea}"/>
					        	<p:menuitem id="btnDatosArea" value="#{msg['botones.datosFuente']}" icon="fa fa-table" actionListener="#{viewTramites.datosArea}" process="@this" update="growl" rendered="#{viewTramites.permiteAltaArea and viewTramites.seleccionadaArea}"/>

			        			<p:separator />
			        			<p:menuitem id="btnHelp2" value="#{msg['botones.ayuda']}" icon="fa fa-question-circle-o" actionListener="#{viewTramites.ayudar()}" process="@this" update="growl" iconPos="top"/>
			        		</p:menuButton>
			        	</h:panelGroup>
			        	<p:commandButton id="btnHelp" value="#{msg['botones.ayuda']}" icon="fa fa-question-circle-o" actionListener="#{viewTramites.ayudar()}" process="@this" update="growl" iconPos="top" rendered="#{not viewTramites.seleccionadasAreas or (not viewTramites.seleccionadaArea and viewTramites.seleccionadasAreas and viewTramites.tramiteSeleccionada eq null and viewTramites.versionSeleccionada eq null)}"/>

					</f:facet>
				</p:toolbar>

				<p:dataTable id="dataTableTramites" var="td" value="#{viewTramites.listaTramiteVersiones}"
												 rows="10" emptyMessage="#{msg['error.emptyRows']}" rowExpandMode="single"
												 scrollable="true" scrollHeight="100%"
						                         paginator="true" paginatorPosition="bottom"
						                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
						                         rowsPerPageTemplate="5,10,15,30"
									        	 selectionMode="single" selection="#{viewTramites.tramiteSeleccionada}" rowKey="#{td.tramite.codigo}">

						<!-- Necesario para actualizar en controlador la fila seleccionada -->
						<p:ajax event="rowSelect" global="false" listener="#{viewTramites.unSelectVersionTramite}" update="@form:toolbarTramites" oncomplete="deseleccionar('T')"/>
             			<p:ajax event="rowDblselect" oncomplete="triggerDoubleClick();" update="@form:toolbarTramites"/>

				       <p:column style="width:16px">
				          <p:rowToggler />
				        </p:column>

						<!-- Columnas -->
					    <p:column headerText="#{msg['viewTramites.headerCodigo']}">
					        <h:outputText value="#{td.tramite.identificador}" />
					    </p:column>

					    <p:column headerText="#{msg['viewTramites.headerDescripcion']}">
					        <h:outputText value="#{td.tramite.descripcion}" />
					    </p:column>

		 				<p:column headerText="#{msg['viewTramites.headerActivo']}">
					        <p:selectBooleanCheckbox value="#{td.tramite.activo}" disabled="true" />
					    </p:column>

					    <p:column headerText="#{msg['viewTramites.headerArea']}">
					        <h:outputText value="#{viewTramites.getIdentificadorArea(td.tramite.idArea)}" />
					    </p:column>


						<p:rowExpansion>
							<!-- Data table -->
							<p:dataTable  id="dataTableVersiones" var="tdVersiones" value="#{td.listaVersiones}"
										  rows="10" emptyMessage="#{msg['error.emptyRows']}"
										  styleClass="w95 margin-left-25 margin-top-10 margin-bottom-10"
							        	  selectionMode="single" selection="#{viewTramites.versionSeleccionada}" rowKey="#{tdVersiones.codigo}"
										  >

								<!-- Necesario para actualizar en controlador la fila seleccionada -->
								<p:ajax event="rowSelect" global="false" listener="#{viewTramites.unSelectTramite}" update="@form:toolbarTramites" oncomplete="deseleccionar('V')"/>
								<p:ajax event="rowDblselect" listener="#{viewTramites.editarVersion}"/>

								<!-- Columnas -->
							    <p:column headerText="#{msg['viewTramitesVersion.headerVersion']}">
							        <h:outputText value="#{tdVersiones.numeroVersion}" />
							    </p:column>

							    <p:column headerText="#{msg['viewTramitesVersion.headerFlujo']}">
							     	<h:outputText value="#{msg['typeFlujo.'.concat(tdVersiones.tipoFlujo)]}" />
							    </p:column>

				 				<p:column headerText="#{msg['viewTramitesVersion.headerActiva']}">
							        <p:selectBooleanCheckbox value="#{tdVersiones.activa}" disabled="true" />
							    </p:column>

								<p:column headerText="#{msg['viewTramitesVersion.headerRelease']}">
							        <h:outputText value="#{tdVersiones.release}" />
							    </p:column>

								<p:column headerText="#{msg['viewTramitesVersion.headerBloqueado']}">
							        <h:outputText value="#{tdVersiones.datosUsuarioBloqueo}" />
							    </p:column>

							</p:dataTable>
						</p:rowExpansion>

					</p:dataTable>
				</div>
			</div>

			<p:commandButton id="hiddenCommandImportar" styleClass="button"  process="@this" action="#{viewTramites.importar()}"  style="display:none">
      			   <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoImportar}" update="growl form:dataTableTramites"  />
	        </p:commandButton>

			<p:commandButton id="hiddenCommandClonar" styleClass="button"   process="@this" update="growl @form"  actionListener="#{viewTramites.duplicarVersion()}" style="display:none">
		    		<p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoClonar}" update="growl form:dataTableTramites"/>
		    </p:commandButton>

	        <p:commandButton id="hiddenCommandMover" styleClass="button"  process="@this"  action="#{viewTramites.moverTramite()}"  style="display:none">
      			   <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoMoverTramite}" update="growl form:dataTableTramites"  />
	        </p:commandButton>

	        <p:commandButton id="hiddenCommandControlAcceso" styleClass="button" process="@this"  action="#{viewTramites.controlAcceso()}"  style="display:none">
      			   <p:ajax event="dialogReturn" listener="#{viewTramites.returnDialogoControlAcceso}" update="growl form:dataTableTramites"  />
	        </p:commandButton>

			<h:outputScript >
		 		function triggerImportarTramite() {
		        	document.getElementById("form:hiddenCommandImportar").click();
		     	}

		     	function triggerClonarTramite() {
		        	document.getElementById("form:hiddenCommandClonar").click();
		     	}

	      	  	function triggerMoverTramite() {
	        		document.getElementById("form:hiddenCommandMover").click();
	      	  	}

	      	  	function triggerControlAcceso() {
	        		document.getElementById("form:hiddenCommandControlAcceso").click();
	      	  	}

	      	  	function triggerDoubleClick() {
	      	  		document.getElementById("form:btnEditarTramite").click();
	      	  	}

				function triggerDoubleClickArea() {
	      	  		document.getElementById("form:btnEditarArea").click();
	      	  	}
				function deseleccionar(modo) {
					$("#form\\:dataTableTramites").find( ".ui-state-highlight").each(function() {

						obj = $( this ).parents("[id^=form\\:dataTableTramites\\:]");
						if (modo == "T" &amp;&amp; obj.length &gt; 0) {
							 $( this ).removeClass("ui-state-highlight");
						}
						if (modo == "V" &amp;&amp;obj.length == 0) {
							 $( this ).removeClass("ui-state-highlight");
						}

					});
				}

		    </h:outputScript>

		    <p:confirmDialog global="true" >
				<p:outputPanel styleClass="confirmar_botonera">
		        	<p:commandButton value="#{msg['botones.si']}" type="button" styleClass="ui-confirmdialog-yes boton-azul" icon="fa fa-check"  process="@form" />
		        	<p:commandButton value="#{msg['botones.no']}" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-close" process="@this"/>
				</p:outputPanel>
		    </p:confirmDialog>
		</h:form>

	</ui:define>

</ui:composition>
