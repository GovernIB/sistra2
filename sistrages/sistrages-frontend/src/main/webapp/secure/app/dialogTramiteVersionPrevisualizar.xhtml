<!DOCTYPE html>
<html lang="#{sessionBean.lang}"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<f:view locale="#{sessionBean.locale}" encoding="UTF-8" contentType="text/html">

<p:importEnum type="es.caib.sistrages.core.api.model.types.TypeIdioma" var="TypeIdioma" />


<h:head>
	<title><h:outputText value="#{msg['dialogTramiteVersionPrevisualizar.header']} - #{dialogTramiteVersionPrevisualizar.tramite.identificador} #{dialogTramiteVersionPrevisualizar.data.numeroVersion} "/></title>
	<style type="text/css">
		.ui-selectonemenu-filter-container {
		    width: 98% !important;
		}

		html, #dialogTramite, #dialogTramite\:j_idt12, #dialogTramite\:j_idt12 > table, #dialogTramite\:j_idt12 > table > tbody,
		#dialogTramite\:j_idt12 > table > tbody > tr:nth-child(4), #dialogTramite\:j_idt12 > table > tbody > tr:nth-child(4) > td.w75,
		#dialogTramite\:datalistValores
		{
			height: 100% !important;
		}

		body {
			height: 90% !important;
		}

		#dialogTramite\:datalistValores > div.ui-datatable-scrollable-body {
			height: 90% !important;
		}

	</style>
</h:head>

<h:body>

	<f:facet name="last">
		<h:outputStylesheet library="css" name="style.css" />
	</f:facet>

	<!-- Parametros dialogo -->
	<f:metadata>
		<f:viewParam name="MODO_ACCESO" value="#{dialogTramiteVersionPrevisualizar.modoAcceso}"/>
		<f:viewParam name="ID" value="#{dialogTramiteVersionPrevisualizar.id}"/>
		<f:viewAction action="#{dialogTramiteVersionPrevisualizar.init}" />
	</f:metadata>

	<h:form id="dialogTramite" styleClass="margin-top-10">
  			<p:outputPanel>
				<!-- Contenido dialogo -->
				<!-- Growl mensajes -->
				<p:growl id="growlDialog" widgetVar="growlDialog" life="#{sessionBean.growlLife}" sticky="#{sessionBean.growlSticky}"  />
				<p:commandButton id="getProcedimientosEnd" style="display:none;" process="@this" actionListener="#{dialogTramiteVersionPrevisualizar.cargaInicial()}"/>
				<p:commandButton id="getProcedimientosRecargar" style="display:none;" process="@this" actionListener="#{dialogTramiteVersionPrevisualizar.cargaRecarga()}"/>

			 	<h:panelGrid rowClasses=", ui-datatable-odd" columnClasses="padding-left-18 w15, w75, w10" columns = "3" cellpadding = "5" cellspacing = "0"  width="100%" style="padding-bottom: 38px !important;">

					<p:outputLabel   for="idioma" value="#{msg['dialogTramiteVersionPrevisualizar.idioma']}" />
                	<p:selectOneMenu id="idioma"  value="#{dialogTramiteVersionPrevisualizar.idioma}" disabled="#{dialogTramiteVersionPrevisualizar.disableTramites and not dialogTramiteVersionPrevisualizar.simularCatalogo}">
						<f:selectItems value="#{dialogTramiteVersionPrevisualizar.idiomas}" var="idi" itemLabel="#{msg['' += idi]}" itemValue="#{idi.toString()}" />
						<p:ajax event="change" update="dialogTramite:txtCopy" listener="#{dialogTramiteVersionPrevisualizar.recalcularURL()}" />
					</p:selectOneMenu >
					<p:outputLabel   value="" />

					<p:outputLabel   for="codigo" value="#{msg['dialogTramiteVersionPrevisualizar.identificador']}" />
                	<p:inputText 	 id="codigo" value="#{dialogTramiteVersionPrevisualizar.tramite.getIdentificadorCompuesto()}" style="width:417px;" readonly="true" />
					<p:outputLabel   value="" />

					<p:outputLabel for="procedimiento" value="#{msg['dialogTramiteVersionPrevisualizar.tramite']}" />
					<p:column>
							<p:selectOneMenu id="procedimiento" filter="true" filterMatchMode="contains" value="#{dialogTramiteVersionPrevisualizar.tramiteSeleccionado}" style="width:400px;" styleClass="margin-top-10" disabled="#{dialogTramiteVersionPrevisualizar.disableTramites or dialogTramiteVersionPrevisualizar.simularCatalogo}">
								<f:selectItems value="#{dialogTramiteVersionPrevisualizar.tramites}" var="tramite" itemLabel="#{dialogTramiteVersionPrevisualizar.getText(tramite)}" itemValue="#{tramite.identificador}" />
								<p:ajax event="change" update="dialogTramite:txtCopy" listener="#{dialogTramiteVersionPrevisualizar.recalcularURL()}" />
							</p:selectOneMenu >

						<div style="display: flex; margin-top:5px; justify-content: space-between; width: 64%;">
							<p:selectBooleanCheckbox id="checkSoloSia" value="#{dialogTramiteVersionPrevisualizar.soloIncorporadosSia}" itemLabel="#{msg['dialogTramiteVersionPrevisualizar.soloSia']}" disabled="#{dialogTramiteVersionPrevisualizar.simularCatalogo}">
								<p:ajax event="change"  listener="#{dialogTramiteVersionPrevisualizar.recargarProcedimientos()}" process="@this"/>
							</p:selectBooleanCheckbox>
							<p:selectBooleanCheckbox id="checkSoloVigentes" value="#{dialogTramiteVersionPrevisualizar.soloVigentes}" itemLabel="#{msg['dialogTramiteVersionPrevisualizar.soloVigente']}" disabled="#{dialogTramiteVersionPrevisualizar.simularCatalogo}">
								<p:ajax event="change"  listener="#{dialogTramiteVersionPrevisualizar.recargarProcedimientos()}"  process="@this"/>
							</p:selectBooleanCheckbox>

							<p:selectBooleanCheckbox id="checkSoloPublicas" value="#{dialogTramiteVersionPrevisualizar.soloPublicas}" itemLabel="#{msg['dialogTramiteVersionPrevisualizar.soloPublicas']}" disabled="#{dialogTramiteVersionPrevisualizar.simularCatalogo}">
								<p:ajax event="change"  listener="#{dialogTramiteVersionPrevisualizar.recargarProcedimientos()}"  process="@this"/>
							</p:selectBooleanCheckbox>
						</div>
						<div style="display: flex; margin-bottom: 5px;">
							<div style="width: 50%;">
								<p style="line-height:20px; padding:0px; margin:0px;">
									<p:outputLabel   styleClass="outputlabel-nota"  value="#{msg['dialogTramiteVersionPrevisualizar.infoVigente']}" />
								</p>
								<p style="line-height:20px; padding:0px; margin:0px;">
									<p:outputLabel   styleClass="outputlabel-nota"  value="#{msg['dialogTramiteVersionPrevisualizar.infoSia']}" />
								</p>
							</div>
							<div style="width: 50%;">
								<p style="line-height:20px; padding:0px; margin:0px;">
									<p:outputLabel   styleClass="outputlabel-nota"  value="#{msg['dialogTramiteVersionPrevisualizar.infoPublico']}" />
								</p>
								<p style="line-height:20px; padding:0px; margin:0px;">
									<p:outputLabel   styleClass="outputlabel-nota"  value="#{msg['dialogTramiteVersionPrevisualizar.infoInterno']}" />
								</p>
								<p style="line-height:20px; padding:0px; margin:0px;">
									<p:outputLabel   styleClass="outputlabel-nota"  value="#{msg['dialogTramiteVersionPrevisualizar.infoReservado']}" />
								</p>
							</div>
						</div>
						<p:selectBooleanCheckbox value="#{dialogTramiteVersionPrevisualizar.simularCatalogo}" itemLabel="#{msg['dialogTramiteVersionPrevisualizar.simularCatalogo']}" rendered="#{dialogTramiteVersionPrevisualizar.isDesarrollo()}" >
							<p:ajax event="change" update="dialogTramite:txtCopy dialogTramite:procedimiento dialogTramite:botonera dialogTramite:btnNuevoValor dialogTramite:btnEditarValor dialogTramite:btnEliminarValor dialogTramite:idioma dialogTramite:procedimiento dialogTramite:checkSoloSia dialogTramite:checkSoloVigentes dialogTramite:checkSoloPublicas" listener="#{dialogTramiteVersionPrevisualizar.recalcularURL()}" />
						</p:selectBooleanCheckbox>
					</p:column>
					<p:outputLabel   value="" />

					<p:outputLabel   value="#{msg['dialogTramiteVersionPrevisualizar.parametros']}" />
                	<p:column>

							<!-- Data table -->
							<p:dataTable  id="datalistValores"
										 var="td" emptyMessage="#{msg['error.emptyRows']}"
										 value="#{dialogTramiteVersionPrevisualizar.parametros}"
										 scrollable="true"
										 scrollHeight="140"
										 paginator="false"
										 selectionMode="single"
										 selection="#{dialogTramiteVersionPrevisualizar.valorSeleccionado}"
										 rowKey="#{td.codigo}"
										 dblClickSelect="true">

								<!-- Necesario para actualizar en controlador la fila seleccionada -->
								<p:ajax event="rowSelect" global="false" />
								<p:ajax event="rowUnselect" />
								<p:ajax event="contextMenu" global="false" process="@this" update="@form:botonesTabla"/>

								<!-- Columnas -->
								<p:column headerText="#{msg['dialogTramiteVersionPrevisualizar.headerParametros.codigo']}" class="ui-panelgrid-cell">
									<h:outputText value="#{td.codigo}" />
							    </p:column>

							    <p:column headerText="#{msg['dialogTramiteVersionPrevisualizar.headerParametros.valor']}" class="ui-panelgrid-cell">
							        <h:outputText value="#{td.valor}" />
							    </p:column>
				 			</p:dataTable>
						</p:column>
					<p:column id="botonesTabla">
								<p>
									<p:commandButton id="btnNuevoValor" title="#{msg['botones.nuevo']}" icon="fa fa-plus" actionListener="#{dialogTramiteVersionPrevisualizar.nuevoValor()}" process="@this" update="growlDialog"  disabled="#{dialogTramiteVersionPrevisualizar.disableTramites and not dialogTramiteVersionPrevisualizar.simularCatalogo}">
		        						<p:ajax event="dialogReturn" listener="#{dialogTramiteVersionPrevisualizar.returnDialogo}" update="growlDialog datalistValores dialogTramite:txtCopy"/>
		        					</p:commandButton>
		        				</p>
		        				<p>
		        					<p:commandButton id="btnEditarValor" title="#{msg['botones.editar']}" icon="fa fa-edit" actionListener="#{dialogTramiteVersionPrevisualizar.editarValor()}" process="@this" update="growlDialog"  disabled="#{dialogTramiteVersionPrevisualizar.disableTramites and not dialogTramiteVersionPrevisualizar.simularCatalogo}">
		        						<p:ajax event="dialogReturn" listener="#{dialogTramiteVersionPrevisualizar.returnDialogo}" update="growlDialog datalistValores dialogTramite:txtCopy"/>
		        					</p:commandButton>
		        				</p>
							    <p>
							    	<p:commandButton id="btnEliminarValor" title="#{msg['botones.eliminar']}" icon="fa fa-minus" actionListener="#{dialogTramiteVersionPrevisualizar.quitarValor()}" process="@this" update="growlDialog datalistValores dialogTramite:txtCopy" disabled="#{dialogTramiteVersionPrevisualizar.disableTramites and not dialogTramiteVersionPrevisualizar.simularCatalogo}">
								    	<p:confirm header="#{msg['confirm.titulo']}" message="#{msg['confirm.borrado']}" icon="fa fa-question-circle fa-3x confirmar_icono"/>
						    		</p:commandButton>
							    </p>

						</p:column>

				</h:panelGrid>

				<h:panelGroup id="popup">
			        <ui:fragment rendered="#{not empty dialogTramiteVersionPrevisualizar.url}">
			            <script>window.open('#{dialogTramiteVersionPrevisualizar.url}');</script>
			            <script>document.getElementById("dialogTramite:btnCancelar").click();</script>
			        </ui:fragment>
			    </h:panelGroup>
			</p:outputPanel>
		  	 <p:outputPanel styleClass="botonera" id="botonera">
		     	<p:toolbar>
		     		<f:facet name="left">
		     			<p:inputText id="txtCopy" value="#{dialogTramiteVersionPrevisualizar.urlTramite}" style="display:none" />
						<p:commandButton id="btnCopiar" value="#{msg['botones.copiar']}" icon="fa fa-copy" onclick="copiarClipboard();" process="@this" disabled="#{dialogTramiteVersionPrevisualizar.disableTramites and not dialogTramiteVersionPrevisualizar.simularCatalogo}"/>
						<p:commandButton id="hiddenCommandGrowl" styleClass="button" process="@this"  action="#{dialogTramiteVersionPrevisualizar.avisarGrowl()}"  style="display:none" />
		     		</f:facet>
					<f:facet name="right">
						<p:commandButton value="#{msg['botones.previsualizarTramite']}" actionListener="#{dialogTramiteVersionPrevisualizar.aceptar}" process="@form" update="@form growlDialog"  styleClass="boton-azul" disabled="#{dialogTramiteVersionPrevisualizar.disableTramites and not dialogTramiteVersionPrevisualizar.simularCatalogo}"/>
		        		<p:commandButton value="#{msg['botones.validarVersion']}" actionListener="#{dialogTramiteVersionPrevisualizar.validar}" process="@this" update="growlDialog"/>
						<p:commandButton id="btnCancelar" value="#{msg['botones.cancelar']}" actionListener="#{dialogTramiteVersionPrevisualizar.cancelar}" process="@this"/>
						<p:commandButton id="btnHelp" value="#{msg['botones.ayuda']}" icon="fa fa-question-circle-o" actionListener="#{dialogTramiteVersionPrevisualizar.ayuda()}" process="@this" />
					</f:facet>
				</p:toolbar>
		    </p:outputPanel>

			<!-- dialogo para confirmar -->
            <p:confirmDialog global="true" >
                <p:outputPanel styleClass="confirmar_botonera">
                    <p:commandButton value="#{msg['botones.si']}" type="button" styleClass="ui-confirmdialog-yes boton-azul" icon="fa fa-check"  process="@form"/>
                    <p:commandButton value="#{msg['botones.no']}" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-close" process="@this"/>
                </p:outputPanel>
            </p:confirmDialog>

		    <h:outputScript >

				function copiarClipboard() {

					// Crea un campo de texto "oculto"
					var aux = document.createElement("input");

					var texto = document.getElementById("dialogTramite:txtCopy");

					// Asigna el contenido del elemento especificado al valor del campo
					aux.setAttribute("value", texto.value);

					// Añade el campo a la página
					document.body.appendChild(aux);

					// Selecciona el contenido del campo
					aux.select();

					// Copia el texto seleccionado
					document.execCommand("copy");

					// Elimina el campo de la página
					document.body.removeChild(aux);

					document.getElementById("dialogTramite:hiddenCommandGrowl").click();
				}


			</h:outputScript>

            <h:outputScript >
            	function llamarBoton() {
                    //Habría que crear un botón de buscar
                    document.getElementById("dialogTramite:getProcedimientosEnd").click();
                }

				function llamarBotonRecargar() {
                    //Habría que crear un botón de buscar
                    document.getElementById("dialogTramite:getProcedimientosRecargar").click();
                }
	             window.onload=function(){

	             	setTimeout(() => {
                          llamarBoton();
                    }, "1000")

	                let contextMenu =  document.getElementsByClassName('ui-contextmenu')[0];
	                onVisible(contextMenu, () => eliminarResaltar());



	               document.addEventListener('contextmenu', function(ev) {
	                    ev.preventDefault();
	                    getPos();
	                    return false;
	                }, false);
	              }



	               function eliminarResaltar(){
	                    let contextMenu =  document.getElementsByClassName('ui-contextmenu')[0];
	                      let elementos = document.getElementsByClassName('resaltar');
	                      if(contextMenu!=null &amp;&amp; contextMenu.style.display=='none' &amp;&amp; elementos.length &gt; 0){
	                        for(let i = 0; i &lt; elementos.length; i++){
	                            elementos[i].classList.remove('resaltar');
	                        }
	                      }
	                }



	               function onVisible(element, callback) {
	                  new IntersectionObserver((entries, observer) => {
	                    entries.forEach(entry => {
	                      if(entry.intersectionRatio == 0) {
	                        callback(element);
	                      }
	                    });
	                  }).observe(element);
	                }


	             function getPos(){
	                 var e = window.event;



	               var posX = e.clientX;
	                var posY = e.clientY;
	                var el = document.elementFromPoint(posX, posY);



	               let elementos = document.getElementsByClassName('resaltar');
	                      if(elementos.length &gt; 0){
	                        for(let i = 0; i &lt; elementos.length; i++){
	                            elementos[i].classList.remove('resaltar');
	                        }
	                      }



	               el.classList.add("resaltar");
	                var aux = document.getElementById("dialogTramite:auxCopiar");
	                if(el.textContent!='' &amp;&amp; el.textContent!='ui-button'){
	                    aux.value = el.textContent;
	                }else if(el.firstChild!=null &amp;&amp; el.firstChild.value!=undefined){
	                    aux.value = el.firstChild.value;
	                }else if(el.value!=null &amp;&amp; el.value!=''){
	                    aux.value = el.value;
	                }else{
			          aux.value = '';
			        }

	             }

            </h:outputScript>

            <p:contextMenu id="mainCm" widgetVar="mainCm">
                <p:menuitem id="mnuCopy" value="#{msg['botones.copiar']}" icon="fa fa-clipboard" styleClass="w90" process="@this :dialogTramite:auxCopiar" update="growlDialog" />
            </p:contextMenu>
            <pe:clipboard id="clipContextCopy" trigger="mnuCopy" action="copy" target="auxCopiar">
                <p:ajax event="success" listener="#{dialogTramiteVersionPrevisualizar.copiadoCorr}" process="@this" update="@this growlDialog"/>
                <p:ajax event="error" listener="#{dialogTramiteVersionPrevisualizar.copiadoErr}" update="@this growlDialog"/>
            </pe:clipboard>

           <p:inputText id="auxCopiar" value="#{dialogTramiteVersionPrevisualizar.portapapeles}" style="padding:0px; opacity:0; width: 1px; height:1px; cursor:default;"/>

			<p:contextMenu for="datalistValores" id="cMenuValores" widgetVar="cMenuValoresWV" beforeShow="return true;">
                <p:menuitem id="mnuCopyValores" value="#{msg['botones.copiar']}" icon="fa fa-clipboard" styleClass="w90" process="@this :dialogTramite:auxCopiar" update="growlDialog" />
                <p:separator/>
				<p:menuitem id="mnuNuevoValores" value="#{msg['botones.nuevo']}" icon="fa fa-file" process="@this" onclick="document.getElementById('dialogTramite:btnNuevoValor').click();" />
				<p:menuitem id="mnuEditarValores" value="#{msg['botones.editar']}" icon="fa fa-edit" process="@this" onclick="document.getElementById('dialogTramite:btnEditarValor').click();"/>
				<p:menuitem id="mnuEliminarValores" value="#{msg['botones.eliminar']}" icon="fa fa-trash-o" process="@this" onclick="document.getElementById('dialogTramite:btnEliminarValor').click();" />
            </p:contextMenu>
            <pe:clipboard id="clipContextCopyPropiedades" trigger="mnuCopyValores" action="copy" target="auxCopiar">
                <p:ajax event="success" listener="#{dialogTramiteVersionPrevisualizar.copiadoCorr}" process="@this" update="@this growlDialog"/>
                <p:ajax event="error" listener="#{dialogTramiteVersionPrevisualizar.copiadoErr}" update="@this growlDialog"/>
            </pe:clipboard>
	</h:form>
</h:body>

</f:view>
</html>
