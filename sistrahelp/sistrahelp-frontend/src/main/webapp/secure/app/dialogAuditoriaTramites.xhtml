<!DOCTYPE html>
<html lang="#{sessionBean.lang}"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:p="http://primefaces.org/ui">

<f:view locale="#{sessionBean.locale}" encoding="UTF-8" contentType="text/html">

<h:head>
	<title><h:outputText value="#{msg['dialogAuditoriaTramites.titulo']}"/></title>
		<style>
		.ui-growl {
		    top: auto;
		    bottom: 30px;
		}
	</style>
</h:head>
<h:body>
  	<f:facet name="last">
    	<h:outputStylesheet library="css" name="style.css" />
  	</f:facet>

	<!-- Parametros dialogo -->
	<f:metadata>
		<f:viewParam name="MODO_ACCESO" value="#{dialogAuditoriaTramites.modoAcceso}"/>
		<f:viewAction action="#{dialogAuditoriaTramites.init}" />
	</f:metadata>
	<h:form id="dialogAuditoriaTramites" styleClass="margin-top-10">

			<h:outputScript >

			  var arrayCm = [];

			  window.onload=function(){
			    let contextMenu =  document.getElementsByClassName('ui-contextmenu')[0];
				onVisible(contextMenu, () => eliminarResaltar());

				document.addEventListener('contextmenu', function(ev) {
			    	ev.preventDefault();
			    	getPos();
			    	return false;
				}, false);
			  }

				function eliminarResaltar(){
					let contextMenu =  document.getElementsByClassName('ui-contextmenu')[0];
			  		let elementos = document.getElementsByClassName('resaltar');
			  		if(contextMenu!=null &amp;&amp; contextMenu.style.display=='none' &amp;&amp; elementos.length &gt; 0){
						for(let i = 0; i &lt; elementos.length; i++){
							elementos[i].classList.remove('resaltar');
						}
			  		}
				}

				function onVisible(element, callback) {
				  new IntersectionObserver((entries, observer) => {
				    entries.forEach(entry => {
				      if(entry.intersectionRatio == 0) {
				        callback(element);
				      }
				    });
				  }).observe(element);
				}

			  function getPos(){
			 	var e = window.event;

			    var posX = e.clientX;
			    var posY = e.clientY;
			    var el = document.elementFromPoint(posX, posY);

			    let elementos = document.getElementsByClassName('resaltar');
			  		if(elementos.length &gt; 0){
						for(let i = 0; i &lt; elementos.length; i++){
							elementos[i].classList.remove('resaltar');
						}
			  		}

				el.classList.add("resaltar");
				var aux = document.getElementById("dialogAuditoriaTramites:auxCopiar");
				if(el.textContent!='' &amp;&amp; el.textContent!='ui-button'){
					aux.value = el.textContent;
				}else if(el.firstChild!=null &amp;&amp; el.firstChild.value!=undefined){
					aux.value = el.firstChild.value;
				}else if(el.value!=null &amp;&amp; el.value!=''){
					aux.value = el.value;
				}else{
		          aux.value = '';
		        }

				 var elEnDataT = document.getElementsByClassName('resaltar')[0];
		        if(elEnDataT!=null &amp;&amp; elEnDataT.id=='dialogAuditoriaTramites:idSesionTramitacion'){
		          document.getElementById("dialogAuditoriaTramites:sesion").classList.remove("d-none");
		          document.getElementById("dialogAuditoriaTramites:sesion").classList.add("d-block");
		        }else{
		          document.getElementById("dialogAuditoriaTramites:sesion").classList.remove("d-block");
		          document.getElementById("dialogAuditoriaTramites:sesion").classList.add("d-none")
		        }

		         if(elEnDataT!=null &amp;&amp; elEnDataT.id=='dialogAuditoriaTramites:nifUsu' &amp;&amp; elEnDataT.childNodes.length>0){
		          document.getElementById("dialogAuditoriaTramites:nif").classList.remove("d-none");
		          document.getElementById("dialogAuditoriaTramites:nif").classList.add("d-block");
		        }else{
		          document.getElementById("dialogAuditoriaTramites:nif").classList.remove("d-block");
		          document.getElementById("dialogAuditoriaTramites:nif").classList.add("d-none")
		        }

		        if(aux.value!='' ){
            var multiple = false;
            var hijos = el.children;
			if((el.tagName == 'UL' || el.tagName == 'TABLE' || el.tagName == 'TR') &amp;&amp; hijos.length &gt; 1){
		            multiple = true;
		                  }else if(hijos.length &gt;= 1 ){
		                  	if(hijos.length==1  &amp;&amp; hijos[0].tagName=='DIV'){
		                  		hijos = hijos[0].children;
		                  	}
			                    for(i=0;i&lt;hijos.length;i++){
					              if(hijos[i].tagName!='SPAN' &amp;&amp; hijos[i].tagName!='LABEL'){
					                multiple=true;
					              }
			                    }

		                  }
                  var listaCm = document.getElementsByClassName('ui-contextmenu');
                  if(multiple){
                    for(i=0;i&lt;listaCm.length;i++){
                    	if(listaCm[i].style.display=='block'  &amp;&amp; !arrayCm.includes(listaCm[i])){
                    		arrayCm.push(listaCm[i]);
                    	}
	                	listaCm[i].classList.add("d-none");
					}
                  }else{
                  	for(i=0;i&lt;listaCm.length;i++){
                  		if(listaCm[i].style.display=='block'  &amp;&amp; !arrayCm.includes(listaCm[i])){
                    		arrayCm.push(listaCm[i]);
                    	}
	                	listaCm[i].classList.remove("d-none");
					}
					if(arrayCm.length&gt;1){
						arrayCm.pop();
						for(let i=0; i&lt;arrayCm.length; i++){
							arrayCm[i].style.display='none';
						}
					}
					arrayCm = [];
                  }

               }

			 }

			</h:outputScript>
					    <p:contextMenu>
       			<p:menuitem value="#{msg['botones.copiar']}" icon="fa fa-clipboard" styleClass="w90" id="mnuCopy"  process="@this :dialogAuditoriaTramites:auxCopiar" update="growlDialog" />
				<p:menuitem value="#{msg['botones.stg']}" icon="fa fa-paper-plane" styleClass="w90" actionListener="#{dialogAuditoriaTramites.sistrages()}" process="@this" rendered="{dialogAuditoriaTramites.dato.getIdTramite() != null}" style="margin-left:4px;width:200px;" />
				<p:menuitem id="sesion" icon="fa fa-window-maximize" process="@this" update="growlDialog" actionListener="#{dialogAuditoriaTramites.pantallaSesion}" value="#{msg['viewConsultaIncidencias.eventos.sesion']}"/>
       			<p:menuitem id="nif" icon="fa fa-window-maximize" process="@this" update="growlDialog" actionListener="#{dialogAuditoriaTramites.pantallaNif}" value="#{msg['viewConsultaIncidencias.eventos.nif']}" />
			</p:contextMenu>

		    <pe:clipboard id="clipContextCopy" trigger="mnuCopy" action="copy" target="auxCopiar">
				<p:ajax event="success" listener="#{dialogAuditoriaTramites.copiadoCorr}" process="@this" update="@this growlDialog"/>
            	<p:ajax event="error" listener="#{dialogAuditoriaTramites.copiadoErr}" update="@this growlDialog"/>
        	</pe:clipboard>

		    <p:inputText id="auxCopiar" value="#{dialogAuditoriaTramites.portapapeles}" style="padding:0px; opacity:0; width: 1px; height:1px; cursor:default;"/>
  			<p:outputPanel>
				<!-- Contenido dialogo -->
				<!-- Growl mensajes -->
				<p:growl id="growlDialog" widgetVar="growlDialog" life="2000" sticky="false" />

				<p:fieldset legend="#{msg['dialogAuditoriaTramites.informacionGeneral']}" styleClass="margin-left-10 margin-right-10  noPadding" rendered="#{dialogAuditoriaTramites.dato.idSesionTramitacion ne null}">
			 		<h:panelGrid rowClasses=",ui-datatable-odd" columnClasses="padding-left-18 w25 grid-right,padding-right-18 w75" columns="2" styleClass="w100">
				 		<p:outputLabel for="evento" value="#{msg['dialogAuditoriaTramites.nombreEvento']}:" />
						<p:inputText id="evento" value="#{dialogAuditoriaTramites.dato.tipoEvento}" readonly="true" size="100"/>

				 		<p:outputLabel for="nomTramite" value="#{msg['dialogAuditoriaTramites.nomTramite']}:" />
						<p:inputText id="nomTramite" value="#{dialogAuditoriaTramites.dato.descripcionTramite}" readonly="true" size="100"/>

						<p:outputLabel for="area" value="#{msg['viewAuditoriaTramites.headArea']}:" />
						<p:inputText id="area" value="#{dialogAuditoriaTramites.dato.area}" readonly="true" size="100"/>

						<p:outputLabel for="idTramite" value="#{msg['dialogAuditoriaTramites.idTramite']}:" />
						<p:inputText id="idTramite" value="#{dialogAuditoriaTramites.splitTramite(dialogAuditoriaTramites.dato.idTramite)}" readonly="true" size="100"/>

				 		<p:outputLabel for="idProcedimientoCP" value="#{msg['dialogAuditoriaTramites.idProcedimiento']}:" />
						<p:inputText id="idProcedimientoCP" value="#{dialogAuditoriaTramites.dato.idProcedimientoCP}" readonly="true" size="100"/>

				 		<p:outputLabel for="idProcedimientoSIA" value="#{msg['dialogAuditoriaTramites.sia']}:" />
						<p:inputText id="idProcedimientoSIA" value="#{dialogAuditoriaTramites.dato.idProcedimientoSIA}" readonly="true" size="100"/>

				 		<p:outputLabel for="idSesionTramitacion" value="#{msg['dialogAuditoriaTramites.idSesion']}:" />
						<p:inputText id="idSesionTramitacion" value="#{dialogAuditoriaTramites.dato.idSesionTramitacion}" readonly="true" size="100"/>

				 		<p:outputLabel for="fecha" value="#{msg['dialogAuditoriaTramites.fecha']}:" />
				 		<p:calendar id="fecha" value="#{dialogAuditoriaTramites.dato.fecha}" size="100" locale="#{sessionBean.locale}" pattern="dd/MM/yyyy HH:mm:ss" showButtonPanel="false" readonly="true"/>

						<p:outputLabel for="nombreUsu" value="#{msg['dialogAuditoriaTramites.nombreUsu']}:" />
						<p:inputText id="nombreUsu" value="#{dialogAuditoriaTramites.dato.nombre.concat(' ').concat(dialogAuditoriaTramites.dato.apellido1).concat(' ').concat(dialogAuditoriaTramites.dato.apellido2)}" readonly="true" size="100"/>

						<p:outputLabel for="nifUsu" value="#{msg['dialogAuditoriaTramites.nifUsu']}:" />
						<p:inputText id="nifUsu" value="#{dialogAuditoriaTramites.dato.nif}" readonly="true" size="100"/>

				 		<p:outputLabel for="descripcion" value="#{msg['dialogAuditoriaTramites.descripcion']}:" />
						<p:inputTextarea id="descripcion" value="#{dialogAuditoriaTramites.dato.descripcion}" readonly="true" rows="3" cols="100"/>

				 		<p:outputLabel for="resultado" value="#{msg['dialogAuditoriaTramites.resultado']}:" />
						<p:inputText id="resultado" value="#{dialogAuditoriaTramites.dato.resultado}" readonly="true" size="100"/>

						<p:outputLabel for="btnSTG" value=""/>
						<p:commandButton id="btnSTG"
									 	value="#{msg['botones.stg']}" icon="fa fa-paper-plane"
										actionListener="#{dialogAuditoriaTramites.sistrages()}" process="@this" style="margin-left:4px;width:200px;" >
							<p:ajax event="dialogReturn" listener="#{dialogAuditoriaTramites.returnDialogo}" update="growlDialog"/>
						</p:commandButton>
					</h:panelGrid>
				</p:fieldset>
				<p:spacer height="5px"/>
				<p:fieldset legend="#{msg['dialogAuditoriaTramites.detalle']}" styleClass="margin-left-10 margin-right-10 margin-bottom-10 noPadding"  rendered="#{dialogAuditoriaTramites.mostrarDetalle}">
			 		<h:panelGrid rowClasses=",ui-datatable-odd" columnClasses="padding-left-18 w18 grid-right,padding-right-18 w75, w5" columns="3" styleClass="w100 h100">
				 	 	<p:outputLabel for="codigoError" value="#{msg['dialogAuditoriaTramites.codigoError']}:" rendered="#{dialogAuditoriaTramites.dato.codigoError != null and not empty dialogAuditoriaTramites.dato.codigoError}" />
				 		<h:panelGroup rendered="#{dialogAuditoriaTramites.dato.codigoError != null and not empty dialogAuditoriaTramites.dato.codigoError}" >
							<p:inputText id="codigoError" value="#{dialogAuditoriaTramites.dato.codigoError}" readonly="true" size="70"/>
							<p:spacer width="5px"/>
							<p:commandButton value="#{msg['dialogAuditoriaTramites.trazaError']}" id="trazaErrorBtn" onclick="PF('dlgTraza').show();" rendered="#{dialogAuditoriaTramites.dato.trazaError ne null}" process="@this"/>

							<p:dialog header="#{msg['dialogAuditoriaTramites.tituloTraza']}" widgetVar="dlgTraza"  modal="true" resizable="true" height="605" width="900" >
								<p:outputPanel styleClass="w100 h100" style="overflow: hidden !important">
							    	<p:inputTextarea value="#{dialogAuditoriaTramites.dato.trazaError}" rows="33" cols="120"  autoResize="true" readonly="true" styleClass="h90" style="width:99%"/>
							    	<p:spacer height="5px"/>
									<p:outputPanel styleClass="confirmar_botonera w100">
										<p:toolbar>
											<f:facet name="right">
												<p:commandButton value="#{msg['botones.volver']}" onclick="PF('dlgTraza').hide();" process="@this"/>
											</f:facet>
										</p:toolbar>
									</p:outputPanel>
								</p:outputPanel>
							</p:dialog>
						</h:panelGroup>
						<p:column rendered="#{dialogAuditoriaTramites.dato.codigoError != null and not empty dialogAuditoriaTramites.dato.codigoError}"> </p:column>

						<p:outputLabel for="dataTablePropiedades" value="#{msg['dialogAuditoriaTramites.headerPropiedades']}:" />
						<p:column>
							<p:dataTable  id="dataTablePropiedades" var="td" value="#{dialogAuditoriaTramites.dato.propiedadesEvento.asArrayList}"
										  emptyMessage="#{msg['error.emptyRows']}"
										  styleClass="h100"
										  scrollable="true"
				                          paginator="false"
				                          selection="#{dialogAuditoriaTramites.valorSeleccionado}"
								          selectionMode="single" rowKey="#{td.key}"
				                          >

								<!-- Columnas -->
							    <p:column headerText="#{msg['dialogAuditoriaTramites.headerPropiedades.codigo']}" style="width:30%;"  class="ui-panelgrid-cell">
							        <h:outputText value="#{td.key}" />
							    </p:column>

							    <p:column headerText="#{msg['dialogAuditoriaTramites.headerPropiedades.valor']}" style="width:70%;word-break: break-all;" class="ui-panelgrid-cell">
							        <h:outputText value="#{td.value}" />
							    </p:column>

				 			</p:dataTable>

			 			</p:column>
			 			<p:column for="dataTablePropiedades" value="#{msg['dialogAuditoriaTramites.headerPropiedades']}:">
							<p:commandButton id="hiddenCommandGrowl" styleClass="button" process="@this" update="growlDialog"  action="#{dialogAuditoriaTramites.avisarGrowl()}"  style="display:none" />
						</p:column>


						<p:spacer height="10px"/>
						<p:spacer height="10px"/>
						<p:spacer height="10px"/>
					</h:panelGrid>
				</p:fieldset>

			</p:outputPanel>
		  	 <p:outputPanel styleClass="botonera">
		     	<p:toolbar>
					<f:facet name="right">
						<p:commandButton id="btnHelp" value="#{msg['botones.ayuda']}" icon="fa fa-question-circle-o" process="@this" actionListener="#{dialogAuditoriaTramites.ayuda()}" />
						<p:commandButton value="#{msg['botones.volver']}" actionListener="#{dialogAuditoriaTramites.cerrar}" process="@this" styleClass="boton-azul" />
					</f:facet>
				</p:toolbar>
		    </p:outputPanel>
	</h:form>
</h:body>

</f:view>
</html>
